TCL
========

## 1. 트랜잭션 개요

- DB의 논리적 연산 단위
- 밀접히 관련되어 분리될 수 없는 한 개 이상의 DB 조작
- 트랜잭션의 대상이 되는 SQL문은 UPDATE, INSERET, DELETE 등 데이터를 수정하는 DML문


### 가. 트랜잭션의 특징

| 특성 | 설명 |
|-|-|
| 원자성<br>(Atomicity)| 트랜잭션에서 정의된 연산들은 모두 성공적으로 실행되거나 전혀 실행되지 않은 상태로 남아야 한다(all or nothing) |
| 일관성<br>(Consistency) | 트랜잭션이 실행되기 전의 DB 내용이 잘못되어 있지 않다면 트랜잭션이 실행된 이후에도 DB의 내용에 잘못이 있으면 안 된다 |
| 고립성<br>(Isolation) | 트랜잭션이 실행되는 도중에 다른 트랜잭션의 영향을 받아 잘못된 결과를 만들어서는 안 된다 |
| 지속성<br>(Durability) | 트랜잭션이 성공적으로 수행되면 그 트랜잭션이 갱신한 DB의 내용은 영구저으로 저장된다 |


### 나. LOCKING

- 트랜잭션이 수행하는 동안 특정 데이터에 대해서 다른 트랜잭션이 접근하지 못 하도록 제한하는 기법
- 잠검이 걸린 데이터는 잠금을 실행한 트랜잭션만 독점적으로 접근, 해제할 수 있다


## 2. COMMIT

- 사용자가 직접 트랜잭션을 완료할 때 사용

### 가. COMMIT 혹은 ROLLBACK 이전 데이터 상태
- 메모리 버퍼에만 영향을 받았기 때문에 데이터의 변경 이전 상태로 복구 가능
- 현재 사용자는 SELECT 문장으로 결과 확인 가능
- 다른 사용자는 현재 사용자가 수행한 명령의 결과를 확인 불가
- 변경된 행은 잠금이 설정되어 다른 사용자가 변경할 수 없음

### 나. COMMIT 혹은 ROLLBACK 이후 데이터 상태
- 데이터에 대한 변경 사항이 DB에 반영됨
- 이전 데이터는 영원히 잃어버리게 된다
- 모든 사용자는 결과를 볼 수 있다
- 관련된 행에 대한 잠금이 풀리고, 다른 사용자들이 행을 조작할 수 있게 된다


## 3. ROLLBACK

- 테이블 내 입력한 데이터나, 수정한 데이터, 삭제한 데이터에 대하여 COMMIT 이전에는 ROLLBACK 명령어를 사용하여 변경 사항을 취소할 수 있음
- ROLLBACK은 데이터 변경 사항이 취소되어 데이터의 이전 상태로 복구됨
- 관련된 행에 대한 LOCKING이 풀리고 다른 사용자들이 데이터 변경을 할 수 있게 된다
- SQL Server는 Auto Commit이 기본 방식이기 때문에 명시적으로 트랜잭션을 선언해야 한다


### ROLLBACK 이후 데이터 상태
- 데이터에 대한 변경 사항이 취소됨
- 이전 데이터는 다시 재저장된다
- 관련된 행에 대한 잠금이 풀리고, 다른 사용자들이 행을 조작할 수 있게 된다


### COMMIT, ROLLBACK 사용시 이점

- 데이터의 무결성 보장
- 영구적인 변경을 하기 전에 데이터의 변경 사항 확인 가능
- 논리적으로 연관된 작업을 그룹핑하여 처리 가능(ex. 계좌이체)


## 4. SAVEPOINT

![rollback](../../img/sql/rollback.jpg)

`SAVEPOINT 세이브포인트명`, `ROLLBACK TO 세이브포인트명`

- SAVEPOINT를 정의하면 ROLLBACK 할 때 트랜잭션에 포함된 전체 작업을 롤백하지 않고, 현 시점에서 SAVEPOINT까지 트랜잭션의 일부만 롤백할 수 있다
- SAVEPOINT 까지만 롤백할 때는 ROLLBACK 뒤에 SAVEPOINT명을 지정한다


## 5. DB별 트랜잭션 처리

### 가. DML의 경우
- Oracle: 사용자가 직접 트랜잭션 처리.
- SQL Server: Auto Commit 모드. DML 구문 성공시 자동 Commit, 실패 시 자동 Rollback

### 나. DDL의 경우
- Oracle: Auto Commit 모드. DDL 문장 실행 시 그 전후 시점에 자동으로 Commit 됨. 즉, DDL 명령을 수행하게 되면, 이전에 Commit 하지 않았던 DML 명령이 DDL 명령 수행 전에 자동으로 Commit 됨.
- SQL Server: Auto Commit 모드

### 다. 접속 관련
- 정상 접속 종료시: 자동으로 트랜잭션 Commit
- 비정상 접속 종료시: 자동으로 트랜잭션 Rollback
